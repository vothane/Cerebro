(ns cerebro.RestrictedBoltzmannMachine.RBM_test
  (:require [clojure.test :refer :all]
            [cerebro.RestrictedBoltzmannMachine.RBM :refer :all]))
 
(deftest prop-up-test
  (testing "RBM propagate up"
    (let [v [0 1 1]
          W [-3.85666 1.17140 3.71995]   
          b -0.93577]
      (is (= (RBM-propup v W b) 0.9812121811403206)))))

(deftest prop-down-test
  (testing "RBM propagate down"
    (let [h [0 1 1]
          W [[2.26799 -0.03222 -2.32391] [0.71964 0.35312 -0.69871] [-3.85666 1.17140 3.71995]]
          b -0.13333
          i 2]
      (is (= (RBM-propdown h W b i) 0.9472455388518453)))))

(deftest sample-h-given-v-test
  (testing "RBM sample h given v"
    (let [hbias  [0.028221124673994354 -0.107446264843636060 -0.9357719706191907]
          v  [0 1 1]
          W [[ 2.2679914975465905 -0.032221378861459635 -2.3239115409314617] 
             [ 0.7196361212711985  0.353115438019772200 -0.6987101836277690] 
             [-3.8566569510903440  1.171395266717829100  3.7199477886071834]]
          
          means [0.08883754884996532 0.38863798230998053 0.981212016787623]
          s_h|v (RBM-sample-h-given-v hbias W v)]
      (is (= (:means s_h|v) means))
      (is (every? #{0 1} (:samples s_h|v))))))

(deftest sample-v-given-h-test
  (testing "RBM sample v given h"
    (let [vbias [0.39999999999999997 1.2166666666666672 -0.13333333333333333]  
          h  [0 1 1]
          W [[2.2679914975465905 -0.032221378861459635 -2.3239115409314617] 
             [0.7196361212711985 0.3531154380197722 -0.698710183627769] 
             [-3.856656951090344 1.1713952667178291 3.7199477886071834]]
          
          means [0.06082386389198515 0.9394131427398393 0.9472452525970866]
          s-v|h (RBM-sample-v-given-h vbias W h)]
      (is (= (:means s-v|h) means))
      (is (every? #{0 1} (:samples s-v|h))))))

(deftest gibbs-hvh-test
  (testing "RBM Gibbs sampling step: hidden -> visible -> hidden"
    (let [vbias [0.39999999999999997 1.2166666666666672 -0.13333333333333333]  
          hbias [0.028221124673994354 -0.107446264843636060 -0.9357719706191907]
          h  [0 1 1]
          W [[2.2679914975465905 -0.032221378861459635 -2.3239115409314617] 
             [0.7196361212711985 0.3531154380197722 -0.698710183627769] 
             [-3.856656951090344 1.1713952667178291 3.7199477886071834]]
          
          means-h|v [0.08883754884996532 0.38863798230998053 0.981212016787623]
          means-v|h [0.06082386389198515 0.9394131427398393 0.9472452525970866]
          gibbs-hvh (RBM-gibbs-hvh hbias vbias W h)]
      (is (= (:means (:v|h gibbs-hvh)) means-v|h))
      (is (every? #{0 1} (:samples (:v|h gibbs-hvh)))) 
      (is (= (:means (:h|v gibbs-hvh)) means-h|v))
      (is (every? #{0 1} (:samples (:h|v gibbs-hvh)))))))

(deftest contrastive-divergence-test
  (testing "RBM contrastive divergence"
    (let [init-rbm {:N 6
                    :weights [[0.14839871643137212 -0.08501163823540675 0.051985421731801734 -0.14855205346676653 -0.044137597789180485 -0.0701731889478024] 
                              [-0.10252046344168927 0.05177738360494413 0.132389904383267 -0.11088185248031387 -0.07047144939818163 0.1342016154235016] 
                              [0.11659342725429114 -0.07565106509550569 0.036360063996785374 -0.08211466451905437 0.09155141306199341 -0.16083974594778425]] 
                    :hbias [0 0 0] 
                    :vbias [0 0 0 0 0 0]}

          calc-rbm (with-redefs-fn {#'RBM-sample-h-given-v (fn [a b c] {:means [0.5288111737223027 0.5204003746406894 0.5193159886734721] :samples [1 0 1]})
                                    #'RBM-gibbs-hvh (fn [a b c d] 
                                                      {:v|h {:means [0.5658630728981506 0.4599204997897266 0.5220720174294667 0.4425876572353885 0.5118512337012591 0.4425022458987821] 
                                                             :samples [1 1 1 0 1 1]} 
                                                       :h|v {:means [0.5002654282727627 0.5362803729362655 0.5020035125943747]
                                                             :samples [0 1 0]}})}
                     #(RBM-contrastive-divergence init-rbm [1 1 1 0 0 0] 0.1 1))
          real-rbm {:N 6
                    :weights [[0.14887447885553112 -0.08453587581124775 0.05246118415596073 -0.14855205346676653 -0.05247535492705986 -0.07851094608568178] 
                              [-0.10278513007994887 0.05151271696668453 0.1321252377450074 -0.11088185248031387 -0.07940945561378605 0.12526360920789717] 
                              [0.1168819685222761 -0.07536252382752073 0.03664860526477033 -0.08211466451905437 0.08318468785208716 -0.1692064711576905]] 
                    :hbias [0.008328909528787289 -0.008938006215604427 0.008299941456760423] 
                    :vbias [0.0 0.0 0.0 0.0 -0.016666666666666673 -0.016666666666666673]}]
    (with-redefs-fn {#'RBM-sample-h-given-v (fn [a b c] {:means [0.5288111737223027 0.5204003746406894 0.5193159886734721] :samples [1 0 1]})
                     #'RBM-gibbs-hvh (fn [a b c d] 
                                       {:v|h {:means [0.5658630728981506 0.4599204997897266 0.5220720174294667 0.4425876572353885 0.5118512337012591 0.4425022458987821] 
                                              :samples [1 1 1 0 1 1]} 
                                        :h|v {:means [0.5002654282727627 0.5362803729362655 0.5020035125943747]
                                              :samples [0 1 0]}})}
                     #(is (= (RBM-contrastive-divergence init-rbm [1 1 1 0 0 0] 0.1 1) real-rbm))))))
